# Ralph Progress Log
Started: Sat Feb 21 02:16:06 PM CET 2026
---

## Codebase Patterns

- tRPC init: `packages/api/src/index.ts` exports `router`, `publicProcedure`, `protectedProcedure`
- context: `packages/api/src/context.ts` - Better Auth session from Hono req headers
- DB: `@omniscient/db` for drizzle instance, `@omniscient/db/schema/skills` for skill table imports
- zod v4: `z.record` requires two args: `z.record(z.string(), z.unknown())`
- drizzle-orm added as direct dep of `@omniscient/api` for query builders (eq, and, or, etc.)
- visibility filter pattern: `visibilityFilter(session)` returns SQL condition for public + owner's private
- `toSkillOutput()` maps DB row to API shape (skillMarkdown -> originalMarkdown/renderedMarkdown)
- typecheck: only `apps/server` has `check-types` script; it compiles through workspace imports
- sub-routers mount directly on appRouter object (e.g. `skills: skillsRouter`)
- neon-http driver does NOT support `db.transaction()` — use sequential queries or `db.batch()` instead
- tRPC callerFactory: `t.createCallerFactory(appRouter)` for direct procedure calls in tests
- mention parser: `packages/api/src/lib/mentions.ts` exports `parseMentions(markdown)` → `Mention[]`

---

### task 1: create skills tRPC router contracts - DONE
- created `packages/api/src/routers/skills.ts` with zod input/output schemas for all 7 procedures
- procedures: list, getById, getBySlug, getResourceByPath, create, update, delete
- response contracts include `originalMarkdown`, `renderedMarkdown`, `resources`, pagination cursor
- mounted under `skills` namespace in appRouter
- all handlers throw "not implemented" - actual logic comes in tasks 2-5
- typecheck + check pass clean

### task 2: implement public list and get skill queries - DONE
- implemented `skills.list` with cursor pagination, search by name/slug (ilike)
- implemented `skills.getById` and `skills.getBySlug` with visibility filter
- public reads: unauthenticated sees only public; authenticated sees public + own private
- private skills from other users return NOT_FOUND (no existence leaks)
- `renderedMarkdown` = `skillMarkdown` for now (task 7 adds rendering)
- added `drizzle-orm` as direct dependency of `@omniscient/api`
- fixed `z.record` to use zod v4 two-arg form throughout
- typecheck + check pass clean

### task 3: implement resource read by skill and path - DONE
- implemented `skills.getResourceByPath` query with skillSlug + resourcePath inputs
- applies same visibility filter as getBySlug: skill must be public or caller's own private
- private skill resources return NOT_FOUND without leaking existence
- returns resource fields + parent skill identity (skillId, skillSlug, skillName)
- typecheck + check pass clean

### task 4: add owner-authenticated create skill mutation - DONE
- implemented `skills.create` mutation body replacing "not implemented" stub
- uses `db.transaction()` to atomically insert skill + resource rows
- `ownerUserId` set from `ctx.session.user.id` (protectedProcedure guarantees session)
- visibility defaults to `"private"` via zod `.default("private")` on input schema
- nested resources inserted in same transaction with `skillId` from created skill
- unauthenticated calls rejected by protectedProcedure middleware (UNAUTHORIZED)
- typecheck + check pass clean

### task 5: add owner-authenticated update and delete mutations - DONE
- implemented `skills.update` with partial field updates and resource upsert/delete/insert
- implemented `skills.delete` as hard delete; FK cascades handle resources and links
- ownership check: fetch skill, compare `ownerUserId` vs session user → FORBIDDEN if mismatch
- resource mutations: `id` + `delete: true` removes, `id` without delete upserts, no `id` inserts new
- fixed neon-http transaction bug: replaced `db.transaction()` with sequential queries in both `create` and `update` (neon-http doesn't support transactions)
- verified with 14 direct tRPC caller tests: auth/ownership guards, field persistence, resource CRUD, cascade deletion
- typecheck + check pass clean

### task 6: parse obsidian mentions from markdown - DONE
- created `packages/api/src/lib/mentions.ts` with `parseMentions()` utility
- regex scans line-by-line for `[[skill:<uuid>]]` and `[[resource:<uuid>]]` tokens
- both `[[` and `]]` must appear on the same line (split-line tokens ignored)
- only `skill:` and `resource:` prefixes accepted; malformed tokens silently skipped
- results deduplicated by `type:targetId` key
- case-insensitive matching (e.g. `[[Skill:...]]` works)
- 15 unit tests covering: valid extraction, mixed text, multi-line, dedup, malformed tokens, edge cases
- typecheck + tests pass clean

### task 7: auto-sync skill_link edges on create and update - DONE
- created `packages/api/src/lib/link-sync.ts` with `syncAutoLinks(sourceSkillId, markdown, userId)`
- delete-then-insert pattern: removes all auto links (metadata.origin = "markdown-auto") for source skill, then inserts fresh set from parsed mentions
- skill mentions → `targetSkillId`, resource mentions → `targetResourceId` (null for the other)
- manual links (without origin tag) are untouched by the delete filter
- wired into `skills.create` (always) and `skills.update` (when skillMarkdown changes)
- neon-http compatible: sequential queries, no transactions needed
- 5 unit tests with mocked db verify delete/insert logic, target field routing, metadata tagging
- typecheck + tests pass clean
