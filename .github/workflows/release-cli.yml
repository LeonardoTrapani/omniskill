name: release cli

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            os: linux
            arch: x64
          - runner: macos-15-intel
            os: darwin
            arch: x64
          - runner: macos-14
            os: darwin
            arch: arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: install dependencies
        run: bun install --frozen-lockfile

      - name: build cli binary
        working-directory: apps/cli
        run: |
          mkdir -p release
          bun build --compile --minify --sourcemap ./src/index.ts --outfile ./release/omniscient-${{ matrix.os }}-${{ matrix.arch }}

      - name: upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.os }}-${{ matrix.arch }}
          path: apps/cli/release/omniscient-${{ matrix.os }}-${{ matrix.arch }}

  sync-default-skills:
    runs-on: ubuntu-24.04
    needs: build

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: install dependencies
        run: bun install --frozen-lockfile

      - name: sync default skills
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BETTER_AUTH_SECRET: 00000000000000000000000000000000
          BETTER_AUTH_URL: https://better-skills.dev
          CORS_ORIGIN: https://better-skills.dev
          GOOGLE_CLIENT_ID: placeholder
          GOOGLE_CLIENT_SECRET: placeholder
          GITHUB_CLIENT_ID: placeholder
          GITHUB_CLIENT_SECRET: placeholder
          NODE_ENV: production
        run: bun run packages/auth/src/sync-default-skills.ts

  publish:
    runs-on: ubuntu-24.04
    needs:
      - build
      - sync-default-skills

    steps:
      - name: download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: cli-*
          merge-multiple: true
          path: release

      - name: generate checksums
        run: sha256sum release/omniscient-* > release/checksums.txt

      - name: publish github release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release/omniscient-linux-x64
            release/omniscient-darwin-x64
            release/omniscient-darwin-arm64
            release/checksums.txt
